<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Lists</title>
    <link rel="stylesheet" href="/static/styles.css">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
    <h1>My Lists</h1>

    <!-- Form to Create a New List -->
    <form action="{{ url_for('add_list') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="list_name" placeholder="New List Name" required>
        <button type="submit">Create List</button>
    </form>

    <!-- Logout -->
    <form action="{{ url_for('auth.logout') }}" method="POST" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Logout</button>
    </form>

    <!-- Speziallisten einbinden -->
    {% include "special_lists.html" %}

    {% if current_user.is_authenticated %}
      <a href="{{ url_for('auth.logout') }}">Abmelden</a>
    {% else %}
      <a href="{{ url_for('auth.login') }}">Login</a>
      <a href="{{ url_for('auth.register') }}">Registrieren</a>
    {% endif %}

    <!-- Normale Listen -->
    <div class="grid-container">
        {% for list in lists %}
        <div class="card" style="background-color: {{ list.color }}" data-list-name="{{ list.name }}">
            <h2>{{ list.name }}</h2>
            <button class="fullscreen-btn" data-list-name="{{ list.name }}">üîç Fullscreen</button>

            <!-- Add Task Form -->
            <form action="{{ url_for('add_task', list_name=list.name) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <h3>Add a New Task</h3>
                <input type="text" name="title" placeholder="Task Title" required>
                <textarea name="description" placeholder="Task Description"></textarea>
                <input type="date" name="due_date">

                <!-- Parent Task -->
                <label for="parent_task_id">Unteraufgabe von:</label>
                <select name="parent_task_id" id="parent_task_id">
                    <option value="">Hauptaufgabe</option>
                    {% for task in list.tasks.incomplete %}
                        <option value="{{ task.id }}">{{ task.title }}</option>
                    {% endfor %}
                </select>

                <button type="submit">Add Task</button>
            </form>

            {% if list.is_secret %}
              <div class="locked-overlay">
                <p>Diese Liste ist passwortgesch√ºtzt.</p>
                <button class="unlock-btn" data-list-name="{{ list.name }}">Entsperren</button>
              </div>
            {% else %}

            <!-- Makro f√ºr verschachtelte Tasks -->
            {% macro render_task(task, level=0) %}
                <li data-task-id="{{ task.id }}" draggable="true" style="margin-left: {{ level * 20 }}px;">
                    <input type="checkbox" {% if task.completed %}checked{% endif %}>
                    <strong>{{ task.title }}</strong> - {{ task.description }}
                    {% if task.due_date %} (Due: {{ task.due_date }}) {% endif %}
                    {% if task.children %}
                        <ul>
                        {% for child in task.children %}
                            {{ render_task(child, level + 1) }}
                        {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% endmacro %}

            <!-- Incomplete Tasks -->
            <ul id="incomplete-tasks-{{ list.name }}">
                {% for task in list.tasks.incomplete %}
                    {{ render_task(task) }}
                {% endfor %}
            </ul>

            <!-- Completed Tasks -->
            <ul id="completed-tasks-{{ list.name }}">
                {% for task in list.tasks.completed %}
                    {{ render_task(task) }}
                {% endfor %}
            </ul>


            <!-- Archivierungs-Button -->
            <form action="{{ url_for('archive_list', list_name=list.name) }}" method="POST"
                  onsubmit="return confirm('Bist du sicher, dass du die Liste archivieren m√∂chtest?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit">Liste archivieren</button>
            </form>

            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Daily Motivation -->
    <h2>Daily Motivation</h2>
    <button id="get-quote-btn">Show Today's Quote</button>
    <p id="quote-display" style="margin-top: 20px; font-size: 1.2em; color: #333;"></p>

    <script>
        document.getElementById("get-quote-btn").addEventListener("click", function () {
            fetch("/daily_quote")
                .then(response => response.text())
                .then(quote => {
                    document.getElementById("quote-display").textContent = quote;
                })
                .catch(error => {
                    console.error("Error fetching quote:", error);
                });
        });
    </script>

    <!-- Buttons -->
    <a href="{{ url_for('daily_video') }}">
        <button style="margin-top: 20px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;">
            Watch Today's Motivation
        </button>
    </a>

    <a href="/calendar">
        <button style="margin-top: 20px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;">
            Open Calendar
        </button>
    </a>

    <a href="{{ url_for('timeline.show_timeline') }}">
      <button style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;">
        Go to Timeline
      </button>
    </a>

    <a href="{{ url_for('archived_lists') }}">
      <button type="button">Archivierte Listen anzeigen</button>
    </a>

    <a href="{{ url_for('secret.show_secret_lists') }}">
      <button type="button">Geheime Listen anzeigen</button>
    </a>

    <a href="{{ url_for('habits.show_habits') }}">
      <button type="button">Gewohnheitstracker</button>
    </a>

    <!-- Kontextmen√º -->
    <div id="context-menu" style="display: none; position: absolute; background-color: white; border: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; border-radius: 5px; padding: 10px;">
        <ul style="list-style: none; margin: 0; padding: 0;">
            <li class="menu-item" data-action="delete">Delete Task</li>
            <li class="menu-item" data-action="rename">Rename Task</li>
        </ul>
    </div>

    <script src="/static/scripts.js"></script>
</body>
</html>
